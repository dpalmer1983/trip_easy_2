<div class="container">

  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <h1>
        Trips
        <a href="/trips/new" class="btn btn-lg btn-default">New Trip
          <i class="fa fa-plus"></i></a>
        </h1>
      </div>
    </div>


    <% @trips.each do |trip| %>

    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">
              <a href="/users/<%=trip.user_id%>"><%=trip.user.username %></a>
              <small>
                <%= time_ago_in_words(trip.updated_at)%> ago (change to trip start date)
              </small>
            </h3>
          </div>

          <div class="panel-body">
            <a href="/trips/<%=trip.id%>">
              <%=trip.name%>
            </a>
            <!-- if the current user is not included in the trip participants, build a form to allow them to join the trip  -->
            <% if trip.participants.where(:id => current_user.id).count == 0 %>
            <p>
              <form action="/create_participant" method="post">
                <!-- Hidden input for authenticity token to protect from forgery -->
                <input name="authenticity_token" type="hidden" value="<%= form_authenticity_token %>">

                <input type="hidden" name="trip_id" value= "<%= trip.id %>">

                <input type="hidden" name="user_id" value="<%= trip.user_id %>">

                <button class="btn btn-link">
                  <i class="fa fa-plus-circle" aria-hidden="true"></i>
                </button>
              </form>
            </p>

            <!-- otherwise (if the current user is in talready a trip participant) build a form to delete their participation in the trip -->
            <% else %>
            <p>
              <!-- change method from post or put in a tag with href =  -->
              <form action="/delete_participant/<%=trip.participants.find_by(:user_id => @current_user.id).id%>" method="get">

                <button class="btn btn-link">
                  <i class="fa fa-minus-circle" aria-hidden="true"></i>
                </button>
              </form>
            </p>

            <% end %>  <!--closes if-then loop on joining-removing from trip-->

            <% trip.participants.each do |participant| %>
            <small>
              <%=User.find_by(:id => participant.user_id).username %>
            </small>
            <% end %> <!--closes loop on listing all trip participants -->



            <% if trip.user_id == current_user.id %>
            <a href="/trips" class="btn btn-primary"> <i class="fa fa-chevron-left"></i>
            </a>

            <a href="/trips/<%= trip.id %>/edit" class="btn btn-warning"> <i class="fa fa-edit"></i>

            </a>

            <a href="/delete_trip/<%= trip.id %>" class="btn btn-danger" rel="nofollow"> <i class="fa fa-trash-o"></i>

            </a>

            <% else %>

            <a href="/trips" class="btn btn-primary"> <i class="fa fa-chevron-left"></i>
            </a>

            <% end %> <!-- closes if-then on edit-delete buttons -->



          </div>       <!-- closes panel body  -->
        </div>     <!-- closes panel -->
      </div>   <!-- closes offset -->
    </div>    <!-- closes row -->

    <% end %> <!-- #closes full loop -->

  </div> <!--closes container -->


  <div class="row">
    <div class="col-md-12">
      <table class="table table-striped table-hover">
        <tr>
          <th>Name</th>
          <th>Destination</th>
          <th>Start date</th>
          <th>End date</th>
          <th>Description</th>
          <th>Trip Organizer</th>
          <th>Actions</th>
        </tr>

        <% @trips.each do |trip| %>
        <tr>

          <td><%= trip.name %></td>
          <td><%= trip.destination %></td>
          <td><%= trip.start_date %></td>
          <td><%= trip.end_date %></td>
          <td><%= trip.description %></td>
          <td><%= trip.user.first_name %> <%= trip.user.last_name %></td>
          <td>
            <a href="/trips/<%= trip.id %>" class="btn btn-primary">Show</a>
            <a href="/trips/<%= trip.id %>/edit" class="btn btn-warning">Edit</a>
            <a href="/delete_trip/<%= trip.id %>" class="btn btn-danger" rel="nofollow">Delete</a>
          </td>
        </tr>
        <% end %>
      </table>
    </div>
